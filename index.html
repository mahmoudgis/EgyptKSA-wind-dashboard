<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KSA Wind Climate Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet Geocoder CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts (Cairo for Arabic) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Plotly.js for Wind Rose -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <!-- Configuration -->
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Arabic Text Style */
        .ar-text { font-family: 'Cairo', sans-serif; direction: rtl; }

        #map {
            height: 100%; width: 100%; min-height: 400px;
            border-radius: 0.5rem; z-index: 1;
            background: #0f172a; 
        }
        
        /* High Contrast Satellite Filter */
        .high-contrast-tile {
            filter: contrast(1.1) saturate(1.2) brightness(0.9); 
        }

        /* Leaflet Controls Adaptation for Dark Map */
        .leaflet-control-geocoder { background: #1e293b !important; border: 1px solid #475569 !important; color: #e2e8f0 !important; }
        .leaflet-control-geocoder-form input { background: #1e293b !important; color: #e2e8f0 !important; border: none !important; }
        .leaflet-control-geocoder-icon { background-color: #334155 !important; border-radius: 4px; color: #e2e8f0 !important; }
        .leaflet-bar a { background-color: #1e293b !important; color: #e2e8f0 !important; border-bottom: 1px solid #475569 !important; }
        .leaflet-bar a:hover { background-color: #334155 !important; color: #ffffff !important; }
        
        /* Layer Control Styling */
        .leaflet-control-layers { 
            background: #1e293b !important; 
            border: 1px solid #475569 !important; 
            color: #e2e8f0 !important;
            border-radius: 4px;
        }
        .leaflet-control-layers-separator { border-top: 1px solid #475569 !important; }
        
        /* Draw Toolbar Customization */
        .leaflet-draw-toolbar a { color: #e2e8f0 !important; background-color: #1e293b !important; border-color: #475569 !important; }
        .leaflet-draw-toolbar a:hover { background-color: #334155 !important; color: #ffffff !important; }
        .leaflet-draw-actions { background-color: #1e293b !important; }
        .leaflet-draw-actions li a { background-color: #1e293b !important; color: #e2e8f0 !important; border-left: 1px solid #475569 !important; }

        /* Popup */
        .leaflet-popup-content-wrapper { background: #1e293b; color: #e2e8f0; border: 1px solid #475569; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
        .leaflet-popup-tip { background: #1e293b; }

        /* Compass Styles */
        .compass-container {
            position: relative; width: 140px; height: 140px;
            background: #1e293b; 
            border-radius: 50%; 
            border: 6px solid #334155;
            margin: 0 auto; 
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        
        .compass-needle-wrapper {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; justify-content: center; align-items: center;
        }

        .compass-arrow-vis {
            position: relative;
            display: flex; flex-direction: column; align-items: center;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
        }

        .arrow-head {
            width: 0; 
            height: 0; 
            border-left: 14px solid transparent;
            border-right: 14px solid transparent;
            border-bottom: 28px solid #ef4444; 
            margin-bottom: -1px; 
        }

        .arrow-shaft {
            width: 8px; 
            height: 60px; 
            background-color: #e2e8f0; 
            border-bottom-left-radius: 2px;
            border-bottom-right-radius: 2px;
        }
        
        .compass-pivot {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 14px; height: 14px;
            background-color: #1e293b;
            border: 3px solid #ef4444;
            border-radius: 50%;
            z-index: 20;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        .compass-label { position: absolute; font-weight: 800; font-size: 1rem; color: #94a3b8; font-family: sans-serif; }
        .c-n { top: 5px; left: 50%; transform: translateX(-50%); color: #ef4444; } 
        .c-s { bottom: 5px; left: 50%; transform: translateX(-50%); }
        .c-e { right: 8px; top: 50%; transform: translateY(-50%); }
        .c-w { left: 8px; top: 50%; transform: translateY(-50%); }

        /* Loading & Modal */
        #loading { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        #uploadModal, #guideModal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); z-index: 9998; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(4px); }
        
        .filter-badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 0.7rem; font-weight: bold; margin-left: 8px; text-transform: uppercase; }

        .no-data-overlay {
            position: absolute; inset: 0;
            background: rgba(15, 23, 42, 0.85);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 50; border-radius: 0.5rem;
            backdrop-filter: blur(2px);
        }
        .no-data-text {
            color: #ef4444; font-weight: bold; font-size: 0.9rem;
            margin-top: 0.5rem; text-align: center;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Loading Screen -->
    <div id="loading">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mb-4"></div>
        <h2 class="text-xl font-bold text-blue-400">Loading Wind Data...</h2>
        <p class="text-slate-500 text-sm mt-2">Parsing CSV & Generating Visualization</p>
    </div>

    <!-- Fallback Upload Modal -->
    <div id="uploadModal">
        <div class="bg-slate-800 p-8 rounded-lg shadow-2xl border border-slate-600 text-center max-w-md mx-4">
            <i class="fa-solid fa-file-csv text-4xl text-blue-400 mb-4"></i>
            <h2 class="text-xl font-bold text-white mb-2">Data Source Required</h2>
            <p class="text-slate-400 text-sm mb-6">
                We couldn't automatically load <code>KSA_Wind_Dashboard_Final_2023.csv</code>. <br>
                Please select your CSV file to continue.
            </p>
            <label class="block mb-4 cursor-pointer">
                <span class="sr-only">Choose File</span>
                <input type="file" id="csvFileInput" accept=".csv" class="block w-full text-sm text-slate-400
                  file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0
                  file:text-sm file:font-semibold file:bg-blue-600 file:text-white
                  file:cursor-pointer hover:file:bg-blue-700
                "/>
            </label>
        </div>
    </div>

    <!-- Guide Modal -->
    <div id="guideModal" onclick="if(event.target === this) document.getElementById('guideModal').style.display='none'">
        <div class="bg-slate-800 p-6 rounded-xl shadow-2xl border border-slate-600 max-w-lg mx-4 ar-text w-full relative max-h-[90vh] flex flex-col">
            <button onclick="document.getElementById('guideModal').style.display='none'" class="absolute top-4 left-4 text-slate-400 hover:text-white transition">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
            <div class="text-center mb-6 shrink-0">
                <i class="fa-solid fa-book-open-reader text-4xl text-blue-400 mb-3"></i>
                <h2 class="text-2xl font-bold text-white">دليل منهجية الحساب</h2>
                <p class="text-sm text-slate-400">شرح لطريقة معالجة وتحليل بيانات الرياح في اللوحة</p>
            </div>
            
            <div class="space-y-4 text-slate-300 text-sm leading-relaxed overflow-y-auto pr-2 flex-1">
                <div class="bg-slate-700/50 p-3 rounded-lg border border-slate-600">
                    <h3 class="text-white font-bold mb-2 flex items-center gap-2"><i class="fa-solid fa-gauge text-emerald-400"></i> 1. متوسط سرعة الرياح (Avg Speed)</h3>
                    <p>يتم حساب السرعة باستخدام <strong>المتوسط الحسابي (Arithmetic Mean)</strong> لقيم سرعة الرياح المسجلة (Scalar Speed) في جميع النقاط المختارة أو النقاط المعروضة في الخريطة اذا لم يتم تحديد أي نقاط من قبل المستخدم.</p>
                </div>
                <div class="bg-slate-700/50 p-3 rounded-lg border border-slate-600">
                    <h3 class="text-white font-bold mb-2 flex items-center gap-2"><i class="fa-solid fa-location-arrow text-orange-400"></i> 2. اتجاه الرياح (Vector Mean)</h3>
                    <p>لتحديد الاتجاه السائد بدقة، نستخدم <strong>المحصلة المتجهية</strong> للمركبات الأفقية والعمودية.</p>
                </div>
                <div class="bg-slate-700/50 p-3 rounded-lg border border-slate-600">
                    <h3 class="text-white font-bold mb-2 flex items-center gap-2"><i class="fa-solid fa-arrow-up-long text-blue-400"></i> 3. مفهوم الأسهم</h3>
                    <p>الأسهم تشير إلى <strong>اتجاه التدفق (Flow Direction)</strong> أي "إلى أين تذهب الرياح".</p>
                </div>
                <div class="bg-slate-700/50 p-3 rounded-lg border border-slate-600">
                    <h3 class="text-white font-bold mb-2 flex items-center gap-2"><i class="fa-solid fa-wind text-red-400"></i> 4. أقصى هبة (Max Gust)</h3>
                    <p>أقصى سرعة لحظية تم رصدها لرصد الحالات المتطرفة.</p>
                </div>

                <div class="mt-6 border-t border-slate-600 pt-4">
                    <h3 class="text-blue-400 font-bold mb-1 text-center">للتواصل</h3>
                    <p class="text-white text-lg font-bold text-center mb-1">محمود عبد الرحمن</p> 
                    <p class="text-slate-400 text-xs text-center mb-4">يمكنكم التواصل للحصول على تقارير تفصيلية أو بيانات مناخية دقيقة.</p>
                    <div class="grid grid-cols-1 gap-3">
                        <a href="https://wa.me/966561318400" target="_blank" class="flex items-center justify-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-lg transition font-bold no-underline shadow-lg">
                            <i class="fa-brands fa-whatsapp text-xl"></i> <span>تواصل واتساب</span>
                        </a>
                        <a href="tel:+966561318400" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition font-bold no-underline shadow-lg">
                            <i class="fa-solid fa-phone text-lg"></i> <span>اتصال هاتفي</span>
                        </a>
                        <a href="mailto:mahmouda18@gmail.com" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center gap-2 bg-slate-600 hover:bg-slate-500 text-white py-2 rounded-lg transition font-bold no-underline shadow-lg">
                            <i class="fa-solid fa-envelope text-lg"></i> <span>mahmouda18@gmail.com</span>
                        </a>
                    </div>
                </div>
            </div>
            <div class="mt-4 text-center shrink-0">
                <button onclick="document.getElementById('guideModal').style.display='none'" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold transition w-full">فهمت ذلك</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 h-16 flex items-center justify-between px-6 shrink-0">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-wind text-blue-400 text-2xl"></i>
            <div>
                <h1 class="text-lg font-bold text-white tracking-wide">KSA Wind Dashboard</h1>
                <p class="text-xs text-slate-400">Climate Data Visualization System</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <input type="file" id="headerFileInput" class="hidden" accept=".csv">
            <button onclick="document.getElementById('headerFileInput').click()" class="bg-slate-700 hover:bg-slate-600 text-slate-300 text-xs px-3 py-2 rounded transition border border-slate-600">
                <i class="fa-solid fa-upload mr-1"></i> Upload CSV
            </button>

            <select id="monthFilter" class="bg-slate-700 text-sm text-white border border-slate-600 rounded px-3 py-1.5 focus:outline-none focus:border-blue-500">
                <option value="All">Annual Overview</option>
                <option value="January">January</option>
                <option value="February">February</option>
                <option value="March">March</option>
                <option value="April">April</option>
                <option value="May">May</option>
                <option value="June">June</option>
                <option value="July">July</option>
                <option value="August">August</option>
                <option value="September">September</option>
                <option value="October">October</option>
                <option value="November">November</option>
                <option value="December">December</option>
            </select>

            <button onclick="document.getElementById('guideModal').style.display='flex'" class="bg-slate-700 hover:bg-slate-600 text-emerald-400 text-xs px-3 py-2 rounded transition border border-slate-600 flex items-center gap-2" title="Methodology Guide">
                <span class="font-bold ar-text">دليل البيانات</span> <i class="fa-solid fa-circle-info"></i>
            </button>

            <button onclick="resetDashboard()" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-4 py-2 rounded transition shadow-lg">
                <i class="fa-solid fa-rotate-left mr-1"></i> Reset
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <!-- Left Panel: Interactive Map -->
        <aside id="mapContainer" class="w-full md:w-1/2 h-1/2 md:h-full relative border-r border-slate-700 transition-all duration-300 ease-in-out">
            <div id="map"></div>
            
            <!-- Map Legend (Dynamic 5 Classes) -->
            <div id="mapLegend" class="absolute bottom-6 left-4 z-[999] bg-white/90 backdrop-blur p-3 rounded border border-slate-300 text-xs shadow-xl transition-opacity duration-300 text-slate-800">
                <h4 class="font-bold mb-2 flex items-center gap-2">
                    Wind Intensity
                    <span class="text-[9px] font-normal bg-slate-200 px-1 rounded text-slate-600">Relative Quintiles</span>
                </h4>
                
                <div id="legendMarkers">
                    <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full" style="background-color: #3b82f6"></span> <span id="leg-1" class="text-slate-600">Loading...</span></div>
                    <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full" style="background-color: #06b6d4"></span> <span id="leg-2" class="text-slate-600">Loading...</span></div>
                    <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full" style="background-color: #eab308"></span> <span id="leg-3" class="text-slate-600">Loading...</span></div>
                    <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full" style="background-color: #f97316"></span> <span id="leg-4" class="text-slate-600">Loading...</span></div>
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full" style="background-color: #ef4444"></span> <span id="leg-5" class="text-slate-600">Loading...</span></div>
                </div>
            </div>
        </aside>

        <!-- Right Panel: Dashboard -->
        <section id="dashboardContainer" class="w-full md:w-1/2 h-1/2 md:h-full bg-slate-900 p-4 overflow-y-auto relative transition-all duration-300 ease-in-out">
            
            <div class="mb-6 flex flex-col md:flex-row md:items-baseline justify-between border-b border-slate-800 pb-4">
                <div>
                    <h2 id="locationTitle" class="text-2xl font-bold text-white flex items-center">
                        National Overview
                        <span id="filterBadge" class="filter-badge bg-blue-500 text-white hidden">Map View</span>
                    </h2>
                    <span id="coordinatesSubtitle" class="text-sm font-mono text-blue-400">All Locations</span>
                </div>
                <div class="text-xs text-slate-500 mt-2 md:mt-0">
                    <span id="locationCount" class="font-bold text-white text-base">0</span> Locations in view
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 relative">
                <!-- Avg Speed -->
                <div class="bg-slate-800 p-4 rounded-lg border border-slate-700 shadow-lg flex items-center justify-between relative overflow-hidden">
                    <div id="kpiAvgOverlay" class="no-data-overlay hidden"><i class="fa-solid fa-triangle-exclamation text-red-500 text-2xl"></i><span class="no-data-text">لا توجد بيانات<br>No Data</span></div>
                    <div>
                        <p class="text-slate-400 text-xs uppercase tracking-wider font-semibold">Avg Speed</p>
                        <h3 class="text-2xl font-bold text-white mt-1"><span id="kpiAvgSpeed">--</span> <span class="text-sm text-slate-500">m/s</span></h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-400">
                        <i class="fa-solid fa-gauge-high"></i>
                    </div>
                </div>
                <!-- Max Speed -->
                <div class="bg-slate-800 p-4 rounded-lg border border-slate-700 shadow-lg flex items-center justify-between relative overflow-hidden">
                    <div id="kpiMaxOverlay" class="no-data-overlay hidden"><i class="fa-solid fa-triangle-exclamation text-red-500 text-2xl"></i><span class="no-data-text">لا توجد بيانات<br>No Data</span></div>
                    <div>
                        <p class="text-slate-400 text-xs uppercase tracking-wider font-semibold">Max Gust</p>
                        <h3 class="text-2xl font-bold text-orange-400 mt-1"><span id="kpiMaxSpeed">--</span> <span class="text-sm text-slate-500">m/s</span></h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-orange-500/10 flex items-center justify-center text-orange-400">
                        <i class="fa-solid fa-wind"></i>
                    </div>
                </div>
                <!-- Dominant Dir -->
                <div class="bg-slate-800 p-4 rounded-lg border border-slate-700 shadow-lg flex items-center justify-between relative overflow-hidden">
                    <div id="kpiDirOverlay" class="no-data-overlay hidden"><i class="fa-solid fa-triangle-exclamation text-red-500 text-2xl"></i><span class="no-data-text">لا توجد بيانات<br>No Data</span></div>
                    <div>
                        <p class="text-slate-400 text-xs uppercase tracking-wider font-semibold">Dominant Dir</p>
                        <h3 id="kpiDir" class="text-2xl font-bold text-emerald-400 mt-1">--</h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-emerald-500/10 flex items-center justify-center text-emerald-400">
                        <i class="fa-regular fa-compass"></i>
                    </div>
                </div>
            </div>

            <!-- Main Charts Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Wind Rose -->
                <div class="bg-slate-800 p-4 rounded-lg border border-slate-700 shadow-lg relative h-80">
                    <div id="roseOverlay" class="no-data-overlay hidden"><i class="fa-solid fa-triangle-exclamation text-red-500 text-3xl"></i><span class="no-data-text">لا توجد بيانات<br>No Data</span></div>
                    <h3 class="text-slate-300 font-semibold mb-2 text-sm flex justify-between absolute top-4 left-4 right-4 z-10 pointer-events-none">
                        <span><i class="fa-solid fa-asterisk mr-2 text-blue-400"></i>Wind Rose Distribution</span>
                        <span id="roseCountLabel" class="text-xs text-slate-500 font-normal"></span>
                    </h3>
                    <div id="windRoseChart" class="w-full h-full"></div>
                </div>

                <!-- Compass -->
                <div class="bg-slate-800 p-4 rounded-lg border border-slate-700 shadow-lg flex flex-col items-center justify-center relative h-80">
                    <div id="compassOverlay" class="no-data-overlay hidden"><i class="fa-solid fa-triangle-exclamation text-red-500 text-3xl"></i><span class="no-data-text">لا توجد بيانات<br>No Data</span></div>
                    <h3 class="text-slate-300 font-semibold mb-6 text-sm w-full text-left flex justify-between">
                        <span><i class="fa-solid fa-location-arrow mr-2 text-blue-400"></i>Average Flow Direction</span>
                        <span id="compassCountLabel" class="text-xs text-slate-500 font-normal"></span>
                    </h3>
                    <div class="compass-container">
                        <span class="compass-label c-n">N</span>
                        <span class="compass-label c-e">E</span>
                        <span class="compass-label c-s">S</span>
                        <span class="compass-label c-w">W</span>
                        <div id="compassNeedleWrapper" class="compass-needle-wrapper">
                            <div class="compass-arrow-vis">
                                <div class="arrow-head"></div>
                                <div class="arrow-shaft"></div>
                                <div class="compass-pivot"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <p class="text-slate-400 text-xs">Vector Mean Direction</p>
                        <p id="compassDegrees" class="text-xl font-bold text-white">0°</p>
                        <p class="text-[10px] text-slate-500 mt-1">Consistent with map arrows</p>
                    </div>
                </div>
            </div>

            <!-- Trend Line Chart -->
            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700 shadow-lg mb-6 relative">
                 <div id="trendOverlay" class="no-data-overlay hidden"><i class="fa-solid fa-triangle-exclamation text-red-500 text-3xl"></i><span class="no-data-text">لا توجد بيانات<br>No Data</span></div>
                <h3 class="text-slate-300 font-semibold mb-4 text-sm"><i class="fa-solid fa-chart-line mr-2 text-blue-400"></i>Monthly Seasonality</h3>
                <div class="h-64 relative">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Footer -->
            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700 shadow-lg mt-6 ar-text">
                <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-emerald-500/10 flex items-center justify-center text-emerald-400 shrink-0">
                            <i class="fa-solid fa-headset text-xl"></i>
                        </div>
                        <div>
                            <h4 class="text-white font-bold text-sm">للتواصل</h4>
                            <p class="text-slate-400 text-xs">محمود عبد الرحمن - مدير مشاريع نظم معلومات جغرافية</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 w-full md:w-auto">
                        <a href="https://wa.me/966561318400" target="_blank" class="flex-1 md:flex-none bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded text-xs font-bold transition flex items-center justify-center gap-2" title="WhatsApp">
                            <i class="fa-brands fa-whatsapp text-sm"></i> <span>واتساب</span>
                        </a>
                        <a href="mailto:mahmouda18@gmail.com" target="_blank" rel="noopener noreferrer" class="flex-1 md:flex-none bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded text-xs font-bold transition flex items-center justify-center gap-2" title="Email">
                            <i class="fa-solid fa-envelope text-sm"></i> <span>ايميل</span>
                        </a>
                    </div>
                </div>
            </div>

        </section>
    </main>

    <!-- Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <!-- Leaflet Draw Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Application Logic -->
    <script>
        // --- State ---
        let rawData = [];
        let groupedData = {}; 
        
        let filterMode = 'ALL'; 
        let selectedLocationKey = null;
        let drawnPointsKeys = []; 

        let mapInstance = null;
        let markersLayer = null;
        let drawnItems = null; 
        
        let chartRose = null; 
        let chartTrend = null;

        // --- Constants ---
        // Moved to Top Level to fix ReferenceError
        const COLORS_5 = ['#3b82f6', '#06b6d4', '#eab308', '#f97316', '#ef4444'];
        const WIND_DIRECTIONS = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
        const DIR_COLS = WIND_DIRECTIONS.map(d => `Pct_${d}`);
        const MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const DIR_DEGREES = WIND_DIRECTIONS.map((d, i) => i * 22.5);
        
        const ARROW_ZOOM_THRESHOLD = 7; 
        const MAX_ARROWS_LIMIT = 6000;

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            attemptInitialLoad();
            
            document.getElementById('monthFilter').addEventListener('change', () => {
                 renderMapLayers(); 
                 refreshDashboard();
            });
            document.getElementById('csvFileInput').addEventListener('change', handleFileUpload);
            document.getElementById('headerFileInput').addEventListener('change', handleFileUpload);
        });

        // --- Map Logic ---
        function initMap() {
            // OPTIMIZATION: preferCanvas forces Leaflet to use Canvas renderer for simple vectors (CircleMarkers)
            mapInstance = L.map('map', { preferCanvas: true }).setView([22.0, 42.0], 5);

            // 1. Create a dedicated pane for labels (zIndex > markers)
            mapInstance.createPane('labels');
            mapInstance.getPane('labels').style.zIndex = 650;
            mapInstance.getPane('labels').style.pointerEvents = 'none';

            // Define Basemaps (10 Options)
            
            // 1. Satellite Analysis (Faded)
            const satFaded = L.layerGroup([
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri',
                    maxZoom: 19,
                    className: 'high-contrast-tile',
                    opacity: 0.25
                })
            ]);

            // 2. Satellite Real
            const satReal = L.layerGroup([
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri',
                    maxZoom: 19
                })
            ]);

            // 3. Dark Matter
            const darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            });

            // 4. Dark Gray Canvas
            const greyMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri',
                maxZoom: 16
            });

            // 5. Positron (Light)
            const lightMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            });

            // 6. World Street Map
            const streetMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri',
                maxZoom: 19
            });

            // 7. OpenStreetMap Standard
            const osmMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 19
            });

            // 8. Ocean Basemap
            const oceanMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri',
                maxZoom: 10
            });

            // 9. Topographic
            const topoMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri',
                maxZoom: 19
            });

            // 10. National Geographic
            const natGeoMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri',
                maxZoom: 12
            });

            // CHANGED: Default is now OpenStreetMap
            osmMap.addTo(mapInstance);

            // CHANGED: Removed persistent labelsLayer overlay. Labels are now part of the basemap itself (like OSM).

            // Layer Controls - Added all 10
            const baseMaps = {
                "OpenStreetMap": osmMap, // Default selected in control
                "قمر صناعي (تحليل)": satFaded,
                "قمر صناعي (واقعي)": satReal,
                "الوضع الداكن": darkMap,
                "الوضع الرمادي": greyMap,
                "الوضع الفاتح": lightMap,
                "خريطة الشوارع": streetMap,
                "خريطة المحيطات": oceanMap,
                "تضاريس (Topo)": topoMap,
                "أطلس (NatGeo)": natGeoMap
            };

            // Removed overlayMaps as user requested removal of persistent overlays
            L.control.layers(baseMaps, null, { position: 'topright' }).addTo(mapInstance);

            L.Control.geocoder({ defaultMarkGeocode: false, collapsed: true, placeholder: 'Search...' })
                .on('markgeocode', function(e) {
                    const bbox = e.geocode.bbox;
                    const poly = L.polygon([bbox.getSouthEast(), bbox.getNorthEast(), bbox.getNorthWest(), bbox.getSouthWest()]);
                    mapInstance.fitBounds(poly.getBounds());
                })
                .addTo(mapInstance);

            markersLayer = L.layerGroup().addTo(mapInstance);
            
            drawnItems = new L.FeatureGroup();
            mapInstance.addLayer(drawnItems);

            const drawControl = new L.Control.Draw({
                draw: {
                    polyline: false,
                    polygon: { allowIntersection: false, showArea: true, shapeOptions: { color: '#2563eb', weight: 2 } },
                    rectangle: { shapeOptions: { color: '#2563eb', weight: 2 } },
                    circle: false, marker: false, circlemarker: false
                },
                edit: { featureGroup: drawnItems, remove: false, edit: false }
            });
            mapInstance.addControl(drawControl);

            // Custom Controls
            const ClearControl = L.Control.extend({
                options: { position: 'topleft' },
                onAdd: function () {
                    const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                    const button = L.DomUtil.create('a', '', container);
                    button.innerHTML = '<i class="fa-solid fa-trash-can"></i>';
                    button.href = '#';
                    button.title = 'Clear All Drawings';
                    button.style.backgroundColor = '#1e293b'; 
                    button.style.color = '#ef4444'; 
                    button.style.fontSize = '14px';
                    button.style.display = 'flex';
                    button.style.alignItems = 'center';
                    button.style.justifyContent = 'center';
                    button.style.width = '30px';
                    button.style.height = '30px';
                    button.style.textDecoration = 'none';
                    button.style.borderBottom = '1px solid #475569';
                    L.DomEvent.on(button, 'click', function (e) {
                        L.DomEvent.stop(e);
                        drawnItems.clearLayers();
                        if (filterMode === 'DRAW') {
                            filterMode = 'BOUNDS';
                            refreshDashboard();
                        }
                    });
                    return container;
                }
            });
            mapInstance.addControl(new ClearControl());

            const FullScreenControl = L.Control.extend({
                options: { position: 'topleft' },
                onAdd: function() {
                    const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                    const button = L.DomUtil.create('a', '', container);
                    button.innerHTML = '<i class="fa-solid fa-expand"></i>';
                    button.href = '#';
                    button.title = 'Maximize Map / Full Screen';
                    button.style.backgroundColor = '#1e293b';
                    button.style.color = '#e2e8f0';
                    button.style.fontSize = '14px';
                    button.style.display = 'flex';
                    button.style.alignItems = 'center';
                    button.style.justifyContent = 'center';
                    button.style.width = '30px';
                    button.style.height = '30px';
                    button.style.textDecoration = 'none';
                    button.style.borderBottom = '1px solid #475569';
                    let isMaximized = false;
                    L.DomEvent.on(button, 'click', function(e) {
                        L.DomEvent.stop(e);
                        const mapContainer = document.getElementById('mapContainer');
                        const dashboardContainer = document.getElementById('dashboardContainer');
                        if (!isMaximized) {
                            mapContainer.classList.remove('md:w-1/2');
                            mapContainer.classList.add('w-full');
                            dashboardContainer.classList.add('hidden');
                            button.innerHTML = '<i class="fa-solid fa-compress"></i>';
                            isMaximized = true;
                        } else {
                            mapContainer.classList.remove('w-full');
                            mapContainer.classList.add('md:w-1/2');
                            dashboardContainer.classList.remove('hidden');
                            button.innerHTML = '<i class="fa-solid fa-expand"></i>';
                            isMaximized = false;
                        }
                        setTimeout(() => { mapInstance.invalidateSize(); }, 300);
                    });
                    return container;
                }
            });
            mapInstance.addControl(new FullScreenControl());

            mapInstance.on(L.Draw.Event.CREATED, function (e) {
                const layer = e.layer;
                drawnItems.clearLayers(); 
                drawnItems.addLayer(layer);
                calculatePointsInShape(layer);
                filterMode = 'DRAW';
                selectedLocationKey = null;
                refreshDashboard();
            });

            mapInstance.on('moveend', () => {
                if (filterMode === 'BOUNDS' || filterMode === 'ALL') {
                    filterMode = 'BOUNDS';
                    renderMapLayers(); 
                    refreshDashboard();
                }
            });
            
            mapInstance.on('zoomend', () => { renderMapLayers(); });

            mapInstance.on('click', () => {
                if (filterMode === 'POINT') {
                    if (drawnItems.getLayers().length > 0) { filterMode = 'DRAW'; } else { filterMode = 'BOUNDS'; }
                    selectedLocationKey = null;
                    mapInstance.closePopup();
                    refreshDashboard();
                }
            });

            setTimeout(() => { mapInstance.invalidateSize(); }, 100);
        }

        // ... existing helper functions (calculatePointsInShape, isPointInPolygon, data loading...)
        function calculatePointsInShape(layer) {
            drawnPointsKeys = [];
            if (layer instanceof L.Rectangle) {
                const bounds = layer.getBounds();
                for (const key in groupedData) {
                    const [lat, lon] = key.split(',').map(Number);
                    if (bounds.contains([lat, lon])) drawnPointsKeys.push(key);
                }
            } else {
                const latlngs = layer.getLatLngs()[0];
                const polyPoints = latlngs.map(p => [p.lat, p.lng]);
                for (const key in groupedData) {
                    const [lat, lon] = key.split(',').map(Number);
                    if (isPointInPolygon([lat, lon], polyPoints)) drawnPointsKeys.push(key);
                }
            }
        }

        function isPointInPolygon(point, vs) {
            var x = point[0], y = point[1];
            var inside = false;
            for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
                var xi = vs[i][0], yi = vs[i][1];
                var xj = vs[j][0], yj = vs[j][1];
                var intersect = ((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        function attemptInitialLoad() {
            try {
                Papa.parse('KSA_Wind_Dashboard_Final_2023.csv', {
                    download: true, header: true, dynamicTyping: true, skipEmptyLines: true,
                    complete: (res) => {
                        if (res.data && res.data.length) { processData(res.data); document.getElementById('loading').style.display = 'none'; } else showUploadModal();
                    },
                    error: () => showUploadModal()
                });
            } catch { showUploadModal(); }
        }

        function showUploadModal() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('uploadModal').style.display = 'flex';
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            document.getElementById('uploadModal').style.display = 'none';
            document.getElementById('loading').style.display = 'flex';
            Papa.parse(file, {
                header: true, dynamicTyping: true, skipEmptyLines: true,
                complete: (res) => { processData(res.data); document.getElementById('loading').style.display = 'none'; },
                error: (err) => alert("Error: " + err.message)
            });
        }

        function processData(data) {
            rawData = data;
            groupedData = {};
            data.forEach(row => {
                if(row.latitude && row.longitude) {
                    const key = `${row.latitude},${row.longitude}`;
                    if (!groupedData[key]) groupedData[key] = [];
                    groupedData[key].push(row);
                }
            });
            filterMode = 'ALL'; 
            renderMapLayers(); 
            refreshDashboard(); 
        }

        function getDynamicColor5(speed, thresholds) {
            if (speed <= thresholds.p20) return COLORS_5[0];
            if (speed <= thresholds.p40) return COLORS_5[1];
            if (speed <= thresholds.p60) return COLORS_5[2];
            if (speed <= thresholds.p80) return COLORS_5[3];
            return COLORS_5[4];
        }

        function calculateVectorMean(rows) {
            if(!rows || rows.length === 0) return 0;
            let uSum = 0, vSum = 0;
            rows.forEach(r => {
                WIND_DIRECTIONS.forEach((dir, i) => {
                    const pct = r[`Pct_${dir}`] || 0;
                    const rad = i * 22.5 * (Math.PI / 180);
                    uSum += pct * Math.sin(rad);
                    vSum += pct * Math.cos(rad);
                });
            });
            let avgTheta = Math.atan2(uSum, vSum); 
            let avgDeg = avgTheta * (180 / Math.PI);
            if (avgDeg < 0) avgDeg += 360;
            return avgDeg; 
        }

        function renderMapLayers() {
            markersLayer.clearLayers();
            const monthFilter = document.getElementById('monthFilter').value;
            const mapBounds = mapInstance.getBounds();
            const hasBounds = mapBounds.isValid();
            const currentZoom = mapInstance.getZoom();
            
            const visiblePointsData = [];
            
            for (const [key, rows] of Object.entries(groupedData)) {
                const [lat, lon] = key.split(',').map(Number);
                let displaySpeed = 0;
                let activeRows = rows;

                if (monthFilter === "All") {
                    displaySpeed = rows.reduce((acc, curr) => acc + curr.Avg_Speed, 0) / rows.length;
                } else {
                    const monthRow = rows.find(r => r.Month_Name === monthFilter);
                    if (monthRow) {
                        displaySpeed = monthRow.Avg_Speed;
                        activeRows = [monthRow];
                    } else {
                        continue; 
                    }
                }
                const pointObj = {lat, lon, displaySpeed, key, activeRows};
                if (!hasBounds || mapBounds.contains([lat, lon])) {
                    visiblePointsData.push(pointObj);
                }
            }

            const isCrowded = visiblePointsData.length > MAX_ARROWS_LIMIT;
            const showArrows = currentZoom >= ARROW_ZOOM_THRESHOLD && !isCrowded;

            const speeds = visiblePointsData.map(p => p.displaySpeed).sort((a, b) => a - b);
            let th = { p20:0, p40:0, p60:0, p80:0 };
            
            if (speeds.length > 0) {
                const len = speeds.length;
                th.p20 = speeds[Math.floor(len * 0.2)] || 0;
                th.p40 = speeds[Math.floor(len * 0.4)] || 0;
                th.p60 = speeds[Math.floor(len * 0.6)] || 0;
                th.p80 = speeds[Math.floor(len * 0.8)] || 0;
            } else {
                th = { p20:2, p40:4, p60:6, p80:8 };
            }
            if (th.p40 <= th.p20) th.p40 = th.p20 + 0.1;
            if (th.p60 <= th.p40) th.p60 = th.p40 + 0.1;
            if (th.p80 <= th.p60) th.p80 = th.p60 + 0.1;

            document.getElementById('leg-1').innerText = `< ${th.p20.toFixed(2)} m/s`;
            document.getElementById('leg-2').innerText = `${th.p20.toFixed(2)} - ${th.p40.toFixed(2)}`;
            document.getElementById('leg-3').innerText = `${th.p40.toFixed(2)} - ${th.p60.toFixed(2)}`;
            document.getElementById('leg-4').innerText = `${th.p60.toFixed(2)} - ${th.p80.toFixed(2)}`;
            document.getElementById('leg-5').innerText = `> ${th.p80.toFixed(2)} m/s`;
            
            visiblePointsData.forEach(pt => {
                const fillColor = getDynamicColor5(pt.displaySpeed, th);
                let marker;

                let flowDir = 0;
                if (showArrows) {
                    const srcDir = calculateVectorMean(pt.activeRows);
                    flowDir = (srcDir + 180) % 360; 
                }

                if (showArrows) {
                    const arrowIcon = L.divIcon({
                        className: 'custom-arrow',
                        html: `
                        <div style="transform: rotate(${flowDir}deg); display:flex; justify-content:center; align-items:center;">
                           <svg width="24" height="24" viewBox="0 0 24 24" fill="${fillColor}" stroke="#333" stroke-width="1">
                               <path d="M12 2L15 19L12 16L9 19L12 2Z" />
                           </svg>
                        </div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12] 
                    });
                    marker = L.marker([pt.lat, pt.lon], { icon: arrowIcon });
                } else {
                    marker = L.circleMarker([pt.lat, pt.lon], {
                        radius: 7, 
                        fillColor: fillColor,
                        stroke: false, 
                        fillOpacity: 0.5, 
                    });
                }
                
                const dirText = showArrows ? `<br>Flow Dir: ${Math.round(flowDir)}°` : '';
                marker.bindPopup(`
                    <div class="text-center" style="color: #333;">
                        <b>Lat: ${pt.lat}, Lon: ${pt.lon}</b><br>
                        Speed: ${pt.displaySpeed.toFixed(2)} m/s
                        ${dirText}
                    </div>
                `);

                marker.on('click', (e) => {
                    L.DomEvent.stopPropagation(e); 
                    filterMode = 'POINT';
                    selectedLocationKey = pt.key;
                    refreshDashboard();
                });
                
                marker.addTo(markersLayer);
            });
        }

        // ... existing refreshDashboard, updateUI, updateWindRose, updateTrendChart ...
        function refreshDashboard() {
            let relevantRows = [];
            let title = "National Overview";
            let subtitle = "All Locations";
            let badgeText = "";
            let badgeClass = "hidden";

            if (filterMode === 'POINT' && selectedLocationKey) {
                relevantRows = groupedData[selectedLocationKey];
                title = "Location Detail";
                subtitle = selectedLocationKey.replace(',', ', ');
                badgeText = "Single Point";
                badgeClass = "bg-emerald-500 text-white";
            } else if (filterMode === 'DRAW') {
                drawnPointsKeys.forEach(k => { if (groupedData[k]) relevantRows.push(...groupedData[k]); });
                title = "Custom Selection";
                subtitle = "User Drawn Area";
                badgeText = "Shape Filter";
                badgeClass = "bg-purple-500 text-white";
                if (relevantRows.length === 0) subtitle = "No points in shape";
            } else if (filterMode === 'BOUNDS') {
                const bounds = mapInstance.getBounds();
                for (const key in groupedData) {
                    const [lat, lon] = key.split(',').map(Number);
                    if (bounds.contains([lat, lon])) relevantRows.push(...groupedData[key]);
                }
                title = "Visible Map Area";
                subtitle = "Geographic Selection";
                badgeText = "Map Filter";
                badgeClass = "bg-blue-500 text-white";
                if (relevantRows.length === 0) subtitle = "No sensors in this view";
            } else {
                relevantRows = rawData;
                title = "National Overview";
                subtitle = "All Locations";
            }

            const monthFilter = document.getElementById('monthFilter').value;
            let displayRows = relevantRows;
            if (monthFilter !== "All") {
                displayRows = relevantRows.filter(r => r.Month_Name === monthFilter);
            }

            updateUI(displayRows, title, subtitle, badgeText, badgeClass);
        }
        
        function updateUI(rows, title, subtitle, badgeText, badgeClass) {
            document.getElementById('locationTitle').firstChild.textContent = title + " "; 
            document.getElementById('coordinatesSubtitle').innerText = subtitle;
            const badge = document.getElementById('filterBadge');
            badge.innerText = badgeText;
            badge.className = "filter-badge " + badgeClass;
            badge.classList.remove('hidden'); 
            if (badgeText === "") badge.classList.add('hidden');
            
            const uniqueLocs = new Set(rows.map(r => r.latitude + ',' + r.longitude)).size;
            document.getElementById('locationCount').innerText = uniqueLocs;
            
            const countText = uniqueLocs > 1 ? `(Based on ${uniqueLocs} locations)` : '(Based on 1 location)';
            document.getElementById('roseCountLabel').innerText = countText;
            document.getElementById('compassCountLabel').innerText = countText;

            const overlays = [ 'kpiAvgOverlay', 'kpiMaxOverlay', 'kpiDirOverlay', 'roseOverlay', 'compassOverlay', 'trendOverlay' ];

            if (rows.length === 0) {
                overlays.forEach(id => document.getElementById(id).classList.remove('hidden'));
                document.getElementById('kpiAvgSpeed').innerText = "--";
                document.getElementById('kpiMaxSpeed').innerText = "--";
                document.getElementById('kpiDir').innerText = "--";
                document.getElementById('compassDegrees').innerText = "--";
                if (chartRose) Plotly.purge('windRoseChart');
                if (chartTrend) { chartTrend.destroy(); chartTrend = null; }
                return;
            } else {
                overlays.forEach(id => document.getElementById(id).classList.add('hidden'));
            }

            const avgSpeed = rows.reduce((a, b) => a + (b.Avg_Speed || 0), 0) / rows.length;
            const maxSpeed = rows.reduce((max, r) => (r.Max_Speed || 0) > max ? (r.Max_Speed || 0) : max, 0);

            const domCounts = {};
            rows.forEach(r => {
                const d = r.Dominant_Dir;
                if (d) domCounts[d] = (domCounts[d] || 0) + 1;
            });
            let topDir = "--";
            if (Object.keys(domCounts).length > 0) {
                 topDir = Object.keys(domCounts).reduce((a, b) => domCounts[a] > domCounts[b] ? a : b);
            }

            const srcDir = calculateVectorMean(rows);
            let finalAngle = (srcDir + 180) % 360;

            document.getElementById('kpiAvgSpeed').innerText = avgSpeed.toFixed(2);
            document.getElementById('kpiMaxSpeed').innerText = maxSpeed.toFixed(2);
            document.getElementById('kpiDir').innerText = topDir;
            
            document.getElementById('compassDegrees').innerText = Math.round(finalAngle) + "°";
            document.getElementById('compassNeedleWrapper').style.transform = `rotate(${finalAngle}deg)`;

            updateWindRose(rows);
            updateTrendChart(rows);
        }

        function updateWindRose(rows) {
            let totals = new Array(16).fill(0);
            rows.forEach(row => {
                DIR_COLS.forEach((col, idx) => totals[idx] += (row[col] || 0));
            });
            const dataValues = totals.map(t => rows.length ? t / rows.length : 0);

            const trace = {
                type: 'barpolar',
                r: dataValues,
                theta: WIND_DIRECTIONS,
                marker: { color: dataValues, colorscale: 'Viridis', line: { color: '#1e293b', width: 1 } },
                hoverinfo: 'theta+r',
                name: 'Frequency %'
            };

            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                margin: { l: 30, r: 30, t: 20, b: 20 },
                font: { family: 'Segoe UI, sans-serif', size: 10, color: '#94a3b8' },
                polar: {
                    bgcolor: 'rgba(0,0,0,0)',
                    radialaxis: { visible: true, showline: false, tickwidth: 0, gridcolor: '#334155', gridwidth: 1, ticksuffix: '%' },
                    angularaxis: { tickwidth: 0, rotation: 90, direction: 'clockwise', gridcolor: '#334155', gridwidth: 1 }
                },
                showlegend: false
            };

            const config = { displayModeBar: false, responsive: true };
            Plotly.newPlot('windRoseChart', [trace], layout, config);
        }

        function updateTrendChart(rows) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            let monthlyAvg = new Array(12).fill(0);
            let monthlyMax = new Array(12).fill(0);
            let counts = new Array(12).fill(0);

            rows.forEach(row => {
                const mIdx = row.month - 1; 
                if (mIdx >= 0 && mIdx < 12) {
                    monthlyAvg[mIdx] += row.Avg_Speed;
                    if (row.Max_Speed > monthlyMax[mIdx]) monthlyMax[mIdx] = row.Max_Speed;
                    counts[mIdx]++;
                }
            });
            monthlyAvg = monthlyAvg.map((sum, i) => counts[i] ? sum / counts[i] : 0);

            if (chartTrend) chartTrend.destroy();
            chartTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: MONTHS,
                    datasets: [
                        { label: 'Avg Speed', data: monthlyAvg, borderColor: '#3b82f6', backgroundColor: '#3b82f6', tension: 0.4, yAxisID: 'y' },
                        { label: 'Max Gust', data: monthlyMax, borderColor: '#f97316', backgroundColor: '#f97316', borderDash: [5, 5], tension: 0.4, yAxisID: 'y' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' }, title: { display: true, text: 'Speed (m/s)', color: '#64748b' } }
                    },
                    plugins: { legend: { labels: { color: '#cbd5e1' } } }
                }
            });
        }
    </script>
</body>
</html>